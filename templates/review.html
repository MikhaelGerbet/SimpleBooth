{% extends "base.html" %}

{% block title %}WizardPhotoBox - Revision{% endblock %}

{% block content %}
<div class="container-fluid p-0" style="height: 100vh; overflow: hidden; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #000;">
    <style>
    * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }
    img { -webkit-user-drag: none; pointer-events: none; }
    button, .btn, a { pointer-events: auto; }
    .main-layout { display: flex; width: 100vw; height: 100vh; background: #000; }
    .photo-wrapper { position: relative; height: 100vh; width: calc(100vh * 1.48); flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #000; }
    #photoPreview { width: 100%; height: 100%; object-fit: cover; background-color: #000; }
    .overlay-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; object-fit: fill; }
    .control-zone { flex: 1; min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.2rem; padding: 1rem; background: #000; }
    .action-btn { width: 70px; height: 70px; border-radius: 50%; border: 3px solid white; color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
    .action-btn:hover { transform: scale(1.08); }
    .action-btn:active { transform: scale(0.95); }
    .btn-print { background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%); box-shadow: 0 4px 20px rgba(40, 167, 69, 0.5); }
    .btn-telegram { background: linear-gradient(180deg, #0088cc 0%, #006699 100%); box-shadow: 0 4px 20px rgba(0, 136, 204, 0.5); }
    .btn-retake { background: linear-gradient(180deg, #fd7e14 0%, #dc6600 100%); box-shadow: 0 4px 20px rgba(253, 126, 20, 0.5); }
    .btn-close-review { background: linear-gradient(180deg, #6c757d 0%, #495057 100%); box-shadow: 0 4px 20px rgba(108, 117, 125, 0.5); width: 55px; height: 55px; font-size: 1.4rem; }
    .qr-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(10px); }
    .qr-popup.show { display: flex; }
    .qr-content { background: white; border-radius: 24px; padding: 2.5rem; text-align: center; max-width: 90vw; max-height: 90vh; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .qr-content h3 { color: #333; margin-bottom: 1rem; font-size: 1.8rem; }
    .qr-content p { color: #666; margin-bottom: 1.5rem; font-size: 1.1rem; }
    .qr-content img { pointer-events: auto; max-width: 280px; max-height: 280px; }
    .qr-close-btn { margin-top: 1.5rem; padding: 1rem 2.5rem; font-size: 1.2rem; background: #dc3545; color: white; border: none; border-radius: 50px; cursor: pointer; transition: all 0.2s; }
    .status-indicator { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 0.75rem 1.5rem; border-radius: 30px; color: white; font-size: 0.9rem; z-index: 10; backdrop-filter: blur(10px); display: none; }
    .status-indicator.show { display: block; }
    .inactivity-bar { position: absolute; bottom: 0; left: 0; height: 4px; background: linear-gradient(90deg, #dc3545, #ff6b7a); width: 100%; transform-origin: left; }
    </style>
    <div class="main-layout">
        <div class="photo-wrapper">
            <img id="photoPreview" src="" alt="Photo capturee">
            <img id="overlayPreview" class="overlay-preview d-none" alt="Overlay">
            <div class="status-indicator" id="statusIndicator"><i class="fas fa-spinner fa-spin me-2"></i><span id="statusText">Chargement...</span></div>
            <div class="inactivity-bar" id="inactivityBar"></div>
        </div>
        <div class="control-zone">
            <button class="action-btn btn-print" id="printBtn" onclick="printPhoto()" title="Imprimer"><i class="fas fa-print"></i></button>
            <button class="action-btn btn-telegram" id="telegramBtn" onclick="showQRCode()" title="Envoyer par Telegram"><i class="fab fa-telegram-plane"></i></button>
            <button class="action-btn btn-retake" onclick="retakePhoto()" title="Reprendre une photo"><i class="fas fa-redo"></i></button>
            <div style="height: 1px; width: 40px; background: rgba(255,255,255,0.2); margin: 0.5rem 0;"></div>
            <button class="action-btn btn-close-review" onclick="closeReview()" title="Fermer"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div class="qr-popup" id="qrPopup">
        <div class="qr-content">
            <h3><i class="fab fa-telegram me-2"></i>Telegram</h3>
            <p>Scannez ce QR code pour recevoir vos photos sur Telegram</p>
            <img id="qrCodeImage" src="" alt="QR Code Telegram">
            <div id="qrLoading" style="padding: 2rem;"><i class="fas fa-spinner fa-spin fa-3x" style="color: #0088cc;"></i><p style="margin-top: 1rem; color: #666;">Chargement du QR Code...</p></div>
            <div id="qrError" style="display: none; padding: 2rem; color: #dc3545;"><i class="fas fa-exclamation-triangle fa-3x"></i><p style="margin-top: 1rem;">Impossible de generer le QR Code.</p></div>
            <br><button class="qr-close-btn" onclick="closeQRPopup()"><i class="fas fa-check me-2"></i>Fermer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Photo passée par le serveur via Jinja (source principale)
let currentPhotoPath = '{{ photo }}' || '';
let inactivityTimer = null;
let inactivityDuration = 30000;
let inactivityStartTime = null;
let inactivityAnimationFrame = null;

document.addEventListener('DOMContentLoaded', function() {
    loadPhoto();
    loadOverlayPreview();
    setupActivityTracking();
    startInactivityTimer();
    checkTelegramConfig();
    checkPrinterConfig();
});

function loadPhoto() {
    const photoPreview = document.getElementById('photoPreview');
    
    // Utiliser la variable Jinja si disponible
    if (currentPhotoPath) {
        // Chercher dans photos/ puis effet/
        photoPreview.src = '/photos/' + currentPhotoPath + '?t=' + Date.now();
        photoPreview.onerror = function() {
            // Si pas trouvé dans photos/, essayer effet/
            this.src = '/effet/' + currentPhotoPath + '?t=' + Date.now();
            this.onerror = function() {
                console.error('Photo introuvable:', currentPhotoPath);
                // Fallback: essayer l'API
                loadPhotoFromAPI();
            };
        };
    } else {
        // Fallback: utiliser l'API
        loadPhotoFromAPI();
    }
}

function loadPhotoFromAPI() {
    fetch('/api/last_photo').then(r => r.json()).then(data => {
        if (data.success && data.photo_path) {
            currentPhotoPath = data.filename || data.photo_path;
            document.getElementById('photoPreview').src = '/' + data.photo_path + '?t=' + Date.now();
        } else {
            console.error('Aucune photo disponible');
        }
    }).catch(err => console.error('Erreur API:', err));
}

function checkTelegramConfig() {
    fetch('/api/config').then(r => r.json()).then(data => {
        if (!data.telegram_enabled || !data.telegram_chat_id) document.getElementById('telegramBtn').style.display = 'none';
    });
}

function checkPrinterConfig() {
    fetch('/api/config').then(r => r.json()).then(data => {
        if (!data.print_enabled) document.getElementById('printBtn').style.display = 'none';
    });
}

function loadOverlayPreview() {
    fetch('/api/overlay/current')
        .then(r => r.json())
        .then(data => {
            const overlayImg = document.getElementById('overlayPreview');
            if (data.enabled && data.url) {
                overlayImg.src = data.url + '?t=' + Date.now();
                overlayImg.classList.remove('d-none');
            } else {
                overlayImg.classList.add('d-none');
            }
        });
}

function showStatus(message) {
    const indicator = document.getElementById('statusIndicator');
    document.getElementById('statusText').textContent = message;
    indicator.classList.add('show');
    setTimeout(() => indicator.classList.remove('show'), 3000);
}

function setupActivityTracking() {
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(e => document.addEventListener(e, resetInactivityTimer, true));
}

function resetInactivityTimer() {
    if (inactivityTimer) clearTimeout(inactivityTimer);
    if (inactivityAnimationFrame) cancelAnimationFrame(inactivityAnimationFrame);
    document.getElementById('inactivityBar').style.transform = 'scaleX(1)';
    startInactivityTimer();
}

function startInactivityTimer() {
    inactivityStartTime = Date.now();
    animateInactivityBar();
    inactivityTimer = setTimeout(() => closeReview(), inactivityDuration);
}

function animateInactivityBar() {
    const bar = document.getElementById('inactivityBar');
    const remaining = 1 - ((Date.now() - inactivityStartTime) / inactivityDuration);
    if (remaining > 0) { bar.style.transform = 'scaleX(' + remaining + ')'; inactivityAnimationFrame = requestAnimationFrame(animateInactivityBar); }
    else bar.style.transform = 'scaleX(0)';
}

function printPhoto() {
    if (!currentPhotoPath) { showStatus('Aucune photo'); return; }
    showStatus('Impression en cours...');
    fetch('/print', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ photo_path: currentPhotoPath }) })
        .then(r => r.json()).then(data => showStatus(data.success ? 'Envoye a l\'imprimante !' : data.error));
    resetInactivityTimer();
}

function showQRCode() {
    const popup = document.getElementById('qrPopup');
    popup.classList.add('show');
    document.getElementById('qrCodeImage').style.display = 'none';
    document.getElementById('qrLoading').style.display = 'block';
    document.getElementById('qrError').style.display = 'none';
    fetch('/api/telegram/qrcode').then(r => r.json()).then(data => {
        document.getElementById('qrLoading').style.display = 'none';
        if (data.success && data.qrcode_url) { document.getElementById('qrCodeImage').src = data.qrcode_url + '?t=' + Date.now(); document.getElementById('qrCodeImage').style.display = 'block'; }
        else document.getElementById('qrError').style.display = 'block';
    }).catch(() => { document.getElementById('qrLoading').style.display = 'none'; document.getElementById('qrError').style.display = 'block'; });
    resetInactivityTimer();
}

function closeQRPopup() { document.getElementById('qrPopup').classList.remove('show'); resetInactivityTimer(); }
function retakePhoto() { window.location.href = '/'; }
function closeReview() { window.location.href = '/'; }
</script>
{% endblock %}

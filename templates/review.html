{% extends "base.html" %}

{% block title %}WizardPhotoBox - Revision{% endblock %}

{% block content %}
<div class="container-fluid p-0" style="height: 100vh; overflow: hidden; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #000;">
    <style>
    * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }
    img { -webkit-user-drag: none; pointer-events: none; }
    button, .btn, a { pointer-events: auto; }
    .main-layout { display: flex; width: 100vw; height: 100vh; background: #000; }
    .photo-wrapper { position: relative; height: 100vh; width: calc(100vh * 1.48); flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #000; }
    #photoPreview { width: 100%; height: 100%; object-fit: cover; background-color: #000; }
    .overlay-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; object-fit: fill; }
    .control-zone { flex: 1; min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.2rem; padding: 1rem; background: #000; }
    .action-btn { width: 70px; height: 70px; border-radius: 50%; border: 3px solid white; color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
    .action-btn:hover { transform: scale(1.08); }
    .action-btn:active { transform: scale(0.95); }
    .btn-print { background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%); box-shadow: 0 4px 20px rgba(40, 167, 69, 0.5); }
    .btn-telegram { background: linear-gradient(180deg, #0088cc 0%, #006699 100%); box-shadow: 0 4px 20px rgba(0, 136, 204, 0.5); }
    .btn-ai { background: linear-gradient(180deg, #9c27b0 0%, #7b1fa2 100%); box-shadow: 0 4px 20px rgba(156, 39, 176, 0.5); }
    .btn-retake { background: linear-gradient(180deg, #fd7e14 0%, #dc6600 100%); box-shadow: 0 4px 20px rgba(253, 126, 20, 0.5); }
    .btn-close-review { background: linear-gradient(180deg, #6c757d 0%, #495057 100%); box-shadow: 0 4px 20px rgba(108, 117, 125, 0.5); width: 55px; height: 55px; font-size: 1.4rem; }
    .qr-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(10px); }
    .qr-popup.show { display: flex; }
    .qr-content { background: white; border-radius: 24px; padding: 2.5rem; text-align: center; max-width: 90vw; max-height: 90vh; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .qr-content h3 { color: #333; margin-bottom: 1rem; font-size: 1.8rem; }
    .qr-content p { color: #666; margin-bottom: 1.5rem; font-size: 1.1rem; }
    .qr-content img { pointer-events: auto; max-width: 280px; max-height: 280px; }
    .qr-close-btn { margin-top: 1.5rem; padding: 1rem 2.5rem; font-size: 1.2rem; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; transition: all 0.2s; }
    .print-status { font-size: 1.3rem; color: #28a745; margin-bottom: 1rem; }
    .print-status i { margin-right: 0.5rem; }
    .status-indicator { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 0.75rem 1.5rem; border-radius: 30px; color: white; font-size: 0.9rem; z-index: 10; backdrop-filter: blur(10px); display: none; }
    .status-indicator.show { display: block; }
    .inactivity-bar { position: absolute; bottom: 0; left: 0; height: 4px; background: linear-gradient(90deg, #dc3545, #ff6b7a); width: 100%; transform-origin: left; }
    
    /* Styles pour popup IA - Uniformisé avec les autres modals */
    .ai-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(10px); }
    .ai-popup.show { display: flex; }
    .ai-content { background: white; border-radius: 24px; padding: 2.5rem; text-align: center; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .ai-content h3 { color: #333; margin-bottom: 0.5rem; font-size: 1.8rem; }
    .ai-content .subtitle { color: #666; margin-bottom: 1rem; font-size: 1rem; }
    .ai-styles-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .ai-style-btn { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 16px; padding: 1rem; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
    .ai-style-btn:hover { border-color: #9c27b0; transform: scale(1.05); background: #fff; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.2); }
    .ai-style-btn:active { transform: scale(0.95); }
    .ai-style-btn.disabled { opacity: 0.4; pointer-events: none; }
    .ai-style-btn i { font-size: 2rem; color: #9c27b0; }
    .ai-style-btn span { color: #333; font-size: 0.85rem; font-weight: 500; }
    .ai-counter { color: #666; font-size: 0.9rem; margin-bottom: 1rem; padding: 0.5rem 1rem; background: #f8f9fa; border-radius: 20px; display: inline-block; }
    .ai-counter.warning { color: #dc3545; background: #fff5f5; }
    .ai-close-btn { padding: 1rem 2.5rem; font-size: 1.1rem; background: #6c757d; color: white; border: none; border-radius: 50px; cursor: pointer; transition: all 0.2s; }
    .ai-close-btn:hover { background: #5a6268; }
    
    /* Animation de chargement IA */
    .ai-loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 300; }
    .ai-loading-overlay.show { display: flex; }
    .ai-loading-spinner { width: 80px; height: 80px; border: 4px solid rgba(156, 39, 176, 0.3); border-top: 4px solid #9c27b0; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1.5rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .ai-loading-text { color: #fff; font-size: 1.3rem; margin-bottom: 0.5rem; }
    .ai-loading-subtext { color: #aaa; font-size: 0.9rem; }
    .ai-loading-progress { width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-top: 1rem; overflow: hidden; }
    .ai-loading-progress-bar { height: 100%; background: linear-gradient(90deg, #9c27b0, #e91e63); width: 0%; animation: progress 15s ease-out forwards; }
    @keyframes progress { 0% { width: 0%; } 50% { width: 60%; } 80% { width: 85%; } 100% { width: 95%; } }
    </style>
    <div class="main-layout">
        <div class="photo-wrapper">
            <img id="photoPreview" src="" alt="Photo capturee">
            <img id="overlayPreview" class="overlay-preview d-none" alt="Overlay">
            <div class="status-indicator" id="statusIndicator"><i class="fas fa-spinner fa-spin me-2"></i><span id="statusText">Chargement...</span></div>
            <div class="inactivity-bar" id="inactivityBar"></div>
        </div>
        <div class="control-zone">
            <button class="action-btn btn-print" id="printBtn" onclick="printPhoto()" title="Imprimer"><i class="fas fa-print"></i></button>
            <button class="action-btn btn-telegram" id="telegramBtn" onclick="showQRCode()" title="Envoyer par Telegram"><i class="fab fa-telegram-plane"></i></button>
            <button class="action-btn btn-ai" id="aiBtn" onclick="applyAIEffect()" title="Appliquer effet IA"><i class="fas fa-magic"></i></button>
            <button class="action-btn btn-retake" onclick="retakePhoto()" title="Reprendre une photo"><i class="fas fa-redo"></i></button>
            <div style="height: 1px; width: 40px; background: rgba(255,255,255,0.2); margin: 0.5rem 0;"></div>
            <button class="action-btn btn-close-review" onclick="closeReview()" title="Fermer"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div class="qr-popup" id="qrPopup">
        <div class="qr-content" style="min-width: 380px;">
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 16px; padding: 1.5rem; margin: 0 auto;">
                <h4 style="color: #0088cc; margin-bottom: 0.5rem; font-size: 1.3rem;">
                    <i class="fab fa-telegram me-2"></i>Telegram
                </h4>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Scannez pour recevoir vos photos sur Telegram</p>
                
                <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
                    <img id="qrCodeImage" src="" alt="QR Code Telegram" style="display: none; max-width: 200px; max-height: 200px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div id="qrLoading" style="text-align: center;">
                        <i class="fas fa-spinner fa-spin fa-2x" style="color: #0088cc;"></i>
                        <p style="margin-top: 0.5rem; color: #888; font-size: 0.85rem;">Chargement...</p>
                    </div>
                    <div id="qrError" style="display: none; text-align: center; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <p style="margin-top: 0.5rem;">Impossible de générer le QR Code</p>
                    </div>
                </div>
            </div>
            
            <button class="qr-close-btn" onclick="closeQRPopup()" style="margin-top: 1.5rem;">
                <i class="fas fa-check me-2"></i>Fermer
            </button>
        </div>
    </div>
    <!-- Modal Impression avec QR Code -->
    <div class="qr-popup" id="printPopup">
        <div class="qr-content" style="min-width: 380px;">
            <div id="printStatusArea" style="margin-bottom: 1.5rem;">
                <div class="print-status" id="printStatus" style="font-size: 1.5rem; margin-bottom: 0;">
                    <i class="fas fa-spinner fa-spin"></i> Envoi à l'imprimante...
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 16px; padding: 1.5rem; margin: 0 auto;">
                <h4 style="color: #0088cc; margin-bottom: 0.5rem; font-size: 1.3rem;">
                    <i class="fab fa-telegram me-2"></i>Récupérez vos photos
                </h4>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Scannez pour voir et télécharger toutes vos photos</p>
                
                <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
                    <img id="printQrCodeImage" src="" alt="QR Code Telegram" style="display: none; max-width: 200px; max-height: 200px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div id="printQrLoading" style="text-align: center;">
                        <i class="fas fa-spinner fa-spin fa-2x" style="color: #0088cc;"></i>
                        <p style="margin-top: 0.5rem; color: #888; font-size: 0.85rem;">Chargement...</p>
                    </div>
                    <div id="printQrError" style="display: none; text-align: center; color: #999;">
                        <i class="fas fa-qrcode fa-3x" style="opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">QR Code non disponible</p>
                    </div>
                </div>
            </div>
            
            <button class="qr-close-btn" onclick="closePrintPopup()" style="margin-top: 1.5rem;">
                <i class="fas fa-check me-2"></i>Terminé
            </button>
        </div>
    </div>
    
    <!-- Popup sélection style IA -->
    <div class="ai-popup" id="aiPopup">
        <div class="ai-content">
            <h3><i class="fas fa-magic me-2"></i>Choisissez un style</h3>
            <p class="subtitle">Transformez votre photo avec l'intelligence artificielle</p>
            <div class="ai-counter" id="aiCounter">0/5 générations utilisées</div>
            <div class="ai-styles-grid" id="aiStylesGrid">
                <!-- Les styles seront chargés dynamiquement -->
            </div>
            <button class="ai-close-btn" onclick="closeAIPopup()">
                <i class="fas fa-times me-2"></i>Annuler
            </button>
        </div>
    </div>
    
    <!-- Overlay de chargement IA -->
    <div class="ai-loading-overlay" id="aiLoadingOverlay">
        <div class="ai-loading-spinner"></div>
        <div class="ai-loading-text" id="aiLoadingText">Génération en cours...</div>
        <div class="ai-loading-subtext" id="aiLoadingSubtext">Transformation de votre photo</div>
        <div class="ai-loading-progress">
            <div class="ai-loading-progress-bar" id="aiProgressBar"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Photo passée par le serveur via Jinja (source principale)
let currentPhotoPath = '{{ photo }}' || '';
let inactivityTimer = null;
let inactivityDuration = 30000;
let inactivityStartTime = null;
let inactivityAnimationFrame = null;

document.addEventListener('DOMContentLoaded', function() {
    loadPhoto();
    loadOverlayPreview();
    setupActivityTracking();
    startInactivityTimer();
    checkTelegramConfig();
    checkPrinterConfig();
    checkAIConfig();
});

function loadPhoto() {
    const photoPreview = document.getElementById('photoPreview');
    
    // Utiliser la variable Jinja si disponible
    if (currentPhotoPath) {
        // Chercher dans photos/ puis effet/
        photoPreview.src = '/photos/' + currentPhotoPath + '?t=' + Date.now();
        photoPreview.onerror = function() {
            // Si pas trouvé dans photos/, essayer effet/
            this.src = '/effet/' + currentPhotoPath + '?t=' + Date.now();
            this.onerror = function() {
                console.error('Photo introuvable:', currentPhotoPath);
                // Fallback: essayer l'API
                loadPhotoFromAPI();
            };
        };
    } else {
        // Fallback: utiliser l'API
        loadPhotoFromAPI();
    }
}

function loadPhotoFromAPI() {
    fetch('/api/last_photo').then(r => r.json()).then(data => {
        if (data.success && data.photo_path) {
            currentPhotoPath = data.filename || data.photo_path;
            document.getElementById('photoPreview').src = '/' + data.photo_path + '?t=' + Date.now();
        } else {
            console.error('Aucune photo disponible');
        }
    }).catch(err => console.error('Erreur API:', err));
}

function checkTelegramConfig() {
    fetch('/api/config').then(r => r.json()).then(data => {
        if (!data.telegram_enabled || !data.telegram_chat_id) document.getElementById('telegramBtn').style.display = 'none';
    });
}

function checkPrinterConfig() {
    fetch('/api/config').then(r => r.json()).then(data => {
        if (!data.print_enabled) document.getElementById('printBtn').style.display = 'none';
    });
}

function checkAIConfig() {
    fetch('/api/config').then(r => r.json()).then(data => {
        if (!data.effect_enabled || !data.runware_api_key) {
            document.getElementById('aiBtn').style.display = 'none';
        } else {
            // Charger les styles IA disponibles
            loadAIStyles();
            loadAIGenerationStatus();
        }
    });
}

// Variables pour la gestion IA
let aiStyles = [];
let aiGenerationCount = 0;
const MAX_AI_GENERATIONS = 5;

function loadAIStyles() {
    fetch('/api/ai_prompts')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.prompts) {
                aiStyles = data.prompts;
                renderAIStylesGrid();
            }
        })
        .catch(err => console.error('Erreur chargement styles IA:', err));
}

function loadAIGenerationStatus() {
    fetch('/api/ai_generation_status')
        .then(r => r.json())
        .then(data => {
            aiGenerationCount = data.generation_count || 0;
            updateAICounter();
        })
        .catch(err => console.error('Erreur statut IA:', err));
}

function updateAICounter() {
    const counter = document.getElementById('aiCounter');
    counter.textContent = `${aiGenerationCount}/${MAX_AI_GENERATIONS} générations utilisées`;
    if (aiGenerationCount >= MAX_AI_GENERATIONS) {
        counter.classList.add('warning');
        counter.textContent += ' - Limite atteinte';
    } else {
        counter.classList.remove('warning');
    }
}

function renderAIStylesGrid() {
    const grid = document.getElementById('aiStylesGrid');
    grid.innerHTML = '';
    
    aiStyles.forEach(style => {
        const btn = document.createElement('button');
        btn.className = 'ai-style-btn';
        if (aiGenerationCount >= MAX_AI_GENERATIONS) {
            btn.classList.add('disabled');
        }
        btn.innerHTML = `
            <i class="fas ${style.icon}"></i>
            <span>${style.name}</span>
        `;
        btn.onclick = () => selectAIStyle(style.id, style.name);
        grid.appendChild(btn);
    });
}

function applyAIEffect() {
    if (!currentPhotoPath) { 
        showStatus('Aucune photo'); 
        return; 
    }
    
    // Vérifier la limite
    if (aiGenerationCount >= MAX_AI_GENERATIONS) {
        showStatus('Limite de générations atteinte');
        return;
    }
    
    // Ouvrir le popup de sélection
    document.getElementById('aiPopup').classList.add('show');
    resetInactivityTimer();
}

function closeAIPopup() {
    document.getElementById('aiPopup').classList.remove('show');
}

function selectAIStyle(styleId, styleName) {
    closeAIPopup();
    
    // Afficher l'overlay de chargement
    document.getElementById('aiLoadingText').textContent = 'Génération en cours...';
    document.getElementById('aiLoadingSubtext').textContent = `Style: ${styleName}`;
    document.getElementById('aiProgressBar').style.animation = 'none';
    setTimeout(() => {
        document.getElementById('aiProgressBar').style.animation = 'progress 15s ease-out forwards';
    }, 10);
    document.getElementById('aiLoadingOverlay').classList.add('show');
    
    // Envoyer la requête
    fetch('/apply_effect', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ prompt_id: styleId }) 
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('aiLoadingOverlay').classList.remove('show');
        
        if (data.success) {
            showStatus(`Style "${data.style_name}" appliqué !`);
            
            // Mettre à jour le compteur
            aiGenerationCount = data.generation_count || (aiGenerationCount + 1);
            updateAICounter();
            renderAIStylesGrid();
            
            // Recharger la photo avec le nouvel effet
            if (data.photo_path) {
                currentPhotoPath = data.photo_path;
                document.getElementById('photoPreview').src = '/' + data.photo_path + '?t=' + Date.now();
            }
            
            // Vérifier si limite atteinte
            if (data.limit_reached) {
                showStatus('Limite de générations atteinte');
            }
        } else {
            if (data.limit_reached) {
                showStatus('Limite de 5 générations atteinte');
                aiGenerationCount = MAX_AI_GENERATIONS;
                updateAICounter();
                renderAIStylesGrid();
            } else {
                showStatus(data.error || 'Erreur IA');
            }
        }
    })
    .catch(err => {
        document.getElementById('aiLoadingOverlay').classList.remove('show');
        showStatus('Erreur de connexion');
        console.error('Erreur IA:', err);
    });
    
    resetInactivityTimer();
}

function loadOverlayPreview() {
    fetch('/api/overlay/current')
        .then(r => r.json())
        .then(data => {
            const overlayImg = document.getElementById('overlayPreview');
            if (data.enabled && data.url) {
                overlayImg.src = data.url + '?t=' + Date.now();
                overlayImg.classList.remove('d-none');
            } else {
                overlayImg.classList.add('d-none');
            }
        });
}

function showStatus(message) {
    const indicator = document.getElementById('statusIndicator');
    document.getElementById('statusText').textContent = message;
    indicator.classList.add('show');
    setTimeout(() => indicator.classList.remove('show'), 3000);
}

function setupActivityTracking() {
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(e => document.addEventListener(e, resetInactivityTimer, true));
}

function resetInactivityTimer() {
    if (inactivityTimer) clearTimeout(inactivityTimer);
    if (inactivityAnimationFrame) cancelAnimationFrame(inactivityAnimationFrame);
    document.getElementById('inactivityBar').style.transform = 'scaleX(1)';
    startInactivityTimer();
}

function startInactivityTimer() {
    inactivityStartTime = Date.now();
    animateInactivityBar();
    inactivityTimer = setTimeout(() => closeReview(), inactivityDuration);
}

function animateInactivityBar() {
    const bar = document.getElementById('inactivityBar');
    const remaining = 1 - ((Date.now() - inactivityStartTime) / inactivityDuration);
    if (remaining > 0) { bar.style.transform = 'scaleX(' + remaining + ')'; inactivityAnimationFrame = requestAnimationFrame(animateInactivityBar); }
    else bar.style.transform = 'scaleX(0)';
}

function printPhoto() {
    if (!currentPhotoPath) { showStatus('Aucune photo'); return; }
    
    // Afficher la modal d'impression
    const popup = document.getElementById('printPopup');
    popup.classList.add('show');
    
    // Reset l'état
    document.getElementById('printStatus').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi à l\'imprimante...';
    document.getElementById('printQrCodeImage').style.display = 'none';
    document.getElementById('printQrLoading').style.display = 'block';
    document.getElementById('printQrError').style.display = 'none';
    
    // Lancer l'impression
    fetch('/print_photo', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ photo_path: currentPhotoPath }) })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('printStatus').innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> Envoyé à l\'imprimante !';
            } else {
                document.getElementById('printStatus').innerHTML = '<i class="fas fa-exclamation-circle" style="color: #dc3545;"></i> ' + (data.error || 'Erreur');
            }
        })
        .catch(err => {
            document.getElementById('printStatus').innerHTML = '<i class="fas fa-exclamation-circle" style="color: #dc3545;"></i> Erreur de connexion';
        });
    
    // Charger le QR Code en parallèle
    fetch('/api/telegram/qrcode')
        .then(r => r.json())
        .then(data => {
            document.getElementById('printQrLoading').style.display = 'none';
            if (data.success && data.qrcode_url) {
                document.getElementById('printQrCodeImage').src = data.qrcode_url + '?t=' + Date.now();
                document.getElementById('printQrCodeImage').style.display = 'block';
            } else {
                document.getElementById('printQrError').style.display = 'block';
            }
        })
        .catch(() => {
            document.getElementById('printQrLoading').style.display = 'none';
            document.getElementById('printQrError').style.display = 'block';
        });
    
    resetInactivityTimer();
}

function closePrintPopup() {
    document.getElementById('printPopup').classList.remove('show');
    resetInactivityTimer();
}

function showQRCode() {
    const popup = document.getElementById('qrPopup');
    popup.classList.add('show');
    document.getElementById('qrCodeImage').style.display = 'none';
    document.getElementById('qrLoading').style.display = 'block';
    document.getElementById('qrError').style.display = 'none';
    fetch('/api/telegram/qrcode').then(r => r.json()).then(data => {
        document.getElementById('qrLoading').style.display = 'none';
        if (data.success && data.qrcode_url) { document.getElementById('qrCodeImage').src = data.qrcode_url + '?t=' + Date.now(); document.getElementById('qrCodeImage').style.display = 'block'; }
        else document.getElementById('qrError').style.display = 'block';
    }).catch(() => { document.getElementById('qrLoading').style.display = 'none'; document.getElementById('qrError').style.display = 'block'; });
    resetInactivityTimer();
}

function closeQRPopup() { document.getElementById('qrPopup').classList.remove('show'); resetInactivityTimer(); }
function retakePhoto() { window.location.href = '/'; }
function closeReview() { window.location.href = '/'; }
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}WizardPhotoBox{% endblock %}

{% block content %}
<div class="container-fluid p-0" style="height: 100vh; overflow: hidden; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #1a1a1a;">
    <style>
    /* Empêcher la sélection sur tous les éléments interactifs */
    * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Empêcher le drag sur les images */
    img {
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        user-drag: none;
        pointer-events: none;
    }
    
    /* Réactiver pointer-events sur les boutons */
    button, .btn, a {
        pointer-events: auto;
    }
    
    /* Layout principal : preview à gauche, options à droite */
    .main-layout {
        display: flex;
        height: 100vh;
        width: 100vw;
    }
    
    /* Zone preview (gauche) - prend l'espace restant */
    .preview-zone {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        overflow: hidden;
    }
    
    /* Wrapper avec ratio 3:2 (15x10 paysage) */
    .video-wrapper {
        position: relative;
        width: 100%;
        max-height: 100%;
        aspect-ratio: 3 / 2;
        overflow: hidden;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    
    /* Vidéo qui remplit le conteneur */
    #videoPreview {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: 100%;
        object-fit: cover;
        background-color: #000;
    }
    
    /* Overlay parfaitement superposé */
    .overlay-preview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
        object-fit: cover;
    }
    
    /* Zone options (droite) */
    .options-zone {
        width: 280px;
        min-width: 280px;
        background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        border-left: 1px solid #444;
    }
    
    /* Bouton capture principal */
    .capture-btn {
        width: 100%;
        padding: 1.5rem;
        font-size: 1.5rem;
        border-radius: 15px;
        background: linear-gradient(180deg, #dc3545 0%, #a71d2a 100%);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        transition: all 0.2s ease;
    }
    
    .capture-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
    }
    
    .capture-btn:active {
        transform: translateY(0);
    }
    
    /* Section d'options */
    .option-section {
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 1rem;
    }
    
    .option-title {
        color: #aaa;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Boutons toggle pour les options */
    .option-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .option-btn {
        flex: 1;
        min-width: 70px;
        padding: 0.75rem 0.5rem;
        border: 2px solid #444;
        background: transparent;
        color: #ccc;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .option-btn:hover {
        border-color: #666;
        color: #fff;
    }
    
    .option-btn.active {
        border-color: #0d6efd;
        background: rgba(13, 110, 253, 0.2);
        color: #fff;
    }
    
    /* Ajustements pour petits écrans */
    @media (max-width: 900px) {
        .options-zone {
            width: 200px;
            min-width: 200px;
            padding: 1rem;
        }
        
        .capture-btn {
            padding: 1rem;
            font-size: 1.2rem;
        }
        
        .option-btn {
            padding: 0.5rem;
            font-size: 0.8rem;
        }
    }
    
    @media (max-width: 600px) {
        .main-layout {
            flex-direction: column;
        }
        
        .options-zone {
            width: 100%;
            min-width: unset;
            flex-direction: row;
            flex-wrap: wrap;
            border-left: none;
            border-top: 1px solid #444;
            padding: 0.75rem;
            gap: 0.75rem;
        }
        
        .option-section {
            flex: 1;
            min-width: 120px;
        }
    }
    </style>
    
    <!-- Layout principal -->
    <div class="main-layout">
        <!-- Zone preview (gauche) -->
        <div class="preview-zone">
            <div class="video-wrapper">
                <img id="videoPreview" 
                     src="{{ url_for('video_stream') }}" 
                     alt="Flux vidéo caméra">
                
                <!-- Overlay transparent superposé -->
                <img id="overlayPreview" 
                     class="overlay-preview d-none" 
                     alt="Overlay">
                
                <!-- Countdown overlay -->
                <div class="countdown d-none position-absolute top-50 start-50 translate-middle" 
                     id="countdown" style="z-index: 10;"></div>
            </div>
        </div>
        
        <!-- Zone options (droite) -->
        <div class="options-zone">
            <!-- Bouton capture principal -->
            <button id="captureBtn" class="capture-btn" onclick="capturePhoto()">
                <i class="fas fa-camera me-2"></i>
                PHOTO
            </button>
            
            <!-- Retardateur -->
            <div class="option-section">
                <div class="option-title">
                    <i class="fas fa-clock"></i>
                    Retardateur
                </div>
                <div class="option-buttons">
                    <button class="option-btn timer-btn" data-timer="3" onclick="setTimer(3)">3s</button>
                    <button class="option-btn timer-btn active" data-timer="5" onclick="setTimer(5)">5s</button>
                    <button class="option-btn timer-btn" data-timer="10" onclick="setTimer(10)">10s</button>
                </div>
            </div>
            
            <!-- Style photo -->
            <div class="option-section">
                <div class="option-title">
                    <i class="fas fa-palette"></i>
                    Style
                </div>
                <div class="option-buttons">
                    <button class="option-btn style-btn active" data-style="color" onclick="setStyle('color')">
                        <i class="fas fa-rainbow me-1"></i>Couleur
                    </button>
                    <button class="option-btn style-btn" data-style="bw" onclick="setStyle('bw')">
                        <i class="fas fa-adjust me-1"></i>N&B
                    </button>
                </div>
            </div>
            
            <!-- Indicateur d'état -->
            <div class="mt-auto text-center">
                <small class="text-muted" id="statusText">Prêt</small>
            </div>
        </div>
    </div>
    
    <!-- Flash blanc pour la prise de photo -->
    <div class="flash-overlay d-none position-fixed top-0 start-0 w-100 h-100" id="flashOverlay" 
         style="background-color: white; z-index: 100; display: flex; align-items: center; justify-content: center;">
        <div style="font-size: 6rem; font-weight: bold; color: black; text-shadow: none;">CHEESE!</div>
    </div>
    
    <!-- Alerte manque de papier -->
    <div class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 20; width: 90%; max-width: 500px;">
        <div class="alert alert-warning d-none d-flex align-items-center" id="paper-alert" style="border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                <strong>Attention !</strong><br>
                <small>Vérifiez le papier de l'imprimante avant de prendre une photo</small>
            </div>
        </div>
    </div>
</div>

<!-- Overlay écran de veille / diaporama -->
<div id="slideshowOverlay" class="d-none" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 9999;">
    <style>
        /* Styles pour l'écran de veille */
        .screensaver-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        /* Photo en fond avec transition fluide */
        .screensaver-photo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        
        .screensaver-photo.active {
            opacity: 1;
        }
        
        /* Bouton capture flottant */
        .screensaver-capture-btn {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1.5rem 3rem;
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(180deg, #dc3545 0%, #a71d2a 100%);
            border: none;
            border-radius: 50px;
            color: white;
            box-shadow: 0 8px 30px rgba(220, 53, 69, 0.6);
            cursor: pointer;
            z-index: 10;
            animation: pulse-btn 2s infinite;
            transition: transform 0.2s ease;
        }
        
        .screensaver-capture-btn:hover {
            transform: translateX(-50%) scale(1.05);
        }
        
        @keyframes pulse-btn {
            0%, 100% { box-shadow: 0 8px 30px rgba(220, 53, 69, 0.6); }
            50% { box-shadow: 0 8px 50px rgba(220, 53, 69, 0.9); }
        }
        
        /* Indicateur de progression */
        .screensaver-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #dc3545, #ff6b7a);
            transition: width linear;
        }
        
        /* Info en haut */
        .screensaver-info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 0.75rem 1.5rem;
            border-radius: 30px;
            color: white;
            font-size: 0.9rem;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        /* Animation d'entrée */
        .screensaver-container.entering .screensaver-capture-btn {
            animation: slide-up 0.5s ease-out forwards;
        }
        
        @keyframes slide-up {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
    
    <div class="screensaver-container">
        <!-- Photos (2 éléments pour transition fluide) -->
        <img id="slideshowImage1" class="screensaver-photo" alt="Photo">
        <img id="slideshowImage2" class="screensaver-photo" alt="Photo">
        
        <!-- Info en haut -->
        <div class="screensaver-info">
            <i class="fas fa-images me-2"></i>
            <span id="slideshowCounter">Photo 1 sur 10</span>
        </div>
        
        <!-- Bouton capture toujours visible -->
        <button class="screensaver-capture-btn" onclick="exitScreensaverAndCapture()">
            <i class="fas fa-camera me-3"></i>
            PRENDRE UNE PHOTO
        </button>
        
        <!-- Barre de progression -->
        <div class="screensaver-progress" id="slideshowProgress"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isCapturing = false;
let currentOverlayUrl = '';
let selectedTimer = {{ config.timer_seconds | default(5) }};
let selectedStyle = 'color';

// Initialiser la caméra et l'overlay au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    initCamera();
    loadOverlayPreview();
    initOptions();
    
    // Vérifier périodiquement si l'overlay a changé (toutes les 5 secondes)
    setInterval(loadOverlayPreview, 5000);
});

// Initialiser les options (sélection par défaut)
function initOptions() {
    // Sélectionner le timer par défaut
    setTimer(selectedTimer);
    // Sélectionner le style par défaut
    setStyle(selectedStyle);
}

// Définir le retardateur
function setTimer(seconds) {
    selectedTimer = seconds;
    document.querySelectorAll('.timer-btn').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.dataset.timer) === seconds) {
            btn.classList.add('active');
        }
    });
    updateStatus();
}

// Définir le style photo
function setStyle(style) {
    selectedStyle = style;
    document.querySelectorAll('.style-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.style === style) {
            btn.classList.add('active');
        }
    });
    
    // Appliquer un filtre CSS sur le preview pour visualiser le style
    const videoPreview = document.getElementById('videoPreview');
    if (style === 'bw') {
        videoPreview.style.filter = 'grayscale(100%)';
    } else {
        videoPreview.style.filter = 'none';
    }
    updateStatus();
}

// Mettre à jour le texte de statut
function updateStatus() {
    const statusText = document.getElementById('statusText');
    const styleText = selectedStyle === 'bw' ? 'N&B' : 'Couleur';
    statusText.textContent = `${selectedTimer}s · ${styleText}`;
}

// Charger l'overlay actuel pour l'afficher sur le flux vidéo
function loadOverlayPreview() {
    fetch('/api/overlay/current')
        .then(response => response.json())
        .then(data => {
            const overlayImg = document.getElementById('overlayPreview');
            const newUrl = data.enabled && data.url ? data.url : '';
            
            // Ne mettre à jour que si l'overlay a changé
            if (newUrl !== currentOverlayUrl) {
                currentOverlayUrl = newUrl;
                
                if (data.enabled && data.url) {
                    overlayImg.src = data.url + '?t=' + Date.now(); // Cache-bust
                    overlayImg.classList.remove('d-none');
                    console.log('Overlay chargé:', data.overlay);
                } else {
                    overlayImg.classList.add('d-none');
                    overlayImg.src = '';
                    console.log('Overlay désactivé');
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement de l\'overlay:', error);
        });
}

function initCamera() {
    try {
        console.log('Initialisation du flux vidéo caméra...');
        
        const videoPreview = document.getElementById('videoPreview');
        
        // Gérer les erreurs de chargement du flux
        videoPreview.onerror = function() {
            console.error('Erreur de chargement du flux vidéo');
            showCameraError();
        };
        
        // Gérer le chargement réussi
        videoPreview.onload = function() {
            console.log('Flux vidéo caméra démarré avec succès');
        };
        
        // Démarrer le flux via l'API
        fetch('/start_camera')
            .then(response => response.json())
            .then(data => {
                console.log('Caméra initialisée:', data.status);
            })
            .catch(error => {
                console.error('Erreur d\'initialisation caméra:', error);
            });
        
    } catch (error) {
        console.error('Erreur d\'accès à la caméra:', error);
        showCameraError();
    }
}

function showCameraError() {
    document.getElementById('videoContainer').innerHTML = 
        '<div class="alert alert-warning m-3">' +
        '<i class="fas fa-exclamation-triangle me-2"></i>' +
        'Impossible d\'accéder à la caméra. Vérifiez que libcamera est installé et que la caméra est connectée.' +
        '</div>';
}

function capturePhoto() {
    if (isCapturing) return;
    
    isCapturing = true;
    const captureBtn = document.getElementById('captureBtn');
    const countdown = document.getElementById('countdown');
    
    // Désactiver le bouton
    captureBtn.disabled = true;
    captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Préparation...';
    
    // Utiliser le timer sélectionné par l'utilisateur
    let timeLeft = selectedTimer;
    countdown.classList.remove('d-none');
    
    const countdownInterval = setInterval(() => {
        countdown.textContent = timeLeft;
        timeLeft--;
        
        if (timeLeft < 0) {
            clearInterval(countdownInterval);
            countdown.textContent = 'CHEESE!';
            
            // Déclencher le flash blanc
            setTimeout(() => {
                countdown.classList.add('d-none');
                const flashOverlay = document.getElementById('flashOverlay');
                flashOverlay.classList.remove('d-none');
                
                // Masquer le flash après un court délai et prendre la photo
                setTimeout(() => {
                    flashOverlay.classList.add('d-none');
                    takePicture();
                }, 300);
            }, 200);
        }
    }, 1000);
}

async function takePicture() {
    try {
        // Envoyer la requête avec le style sélectionné
        const response = await fetch('/capture', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                style: selectedStyle
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Rediriger vers la page de révision
            window.location.href = '/review';
        } else {
            throw new Error(result.error || 'Erreur de capture');
        }
        
    } catch (error) {
        console.error('Erreur lors de la capture:', error);
        alert('Erreur lors de la prise de photo: ' + error.message);
        
        resetCaptureButton();
    }
}

function resetCaptureButton() {
    isCapturing = false;
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.disabled = false;
    captureBtn.innerHTML = '<i class="fas fa-camera me-2"></i>PHOTO';
}

// Variables pour le diaporama / écran de veille
let slideshowConfig = null;
let slideshowPhotos = [];
let slideshowActive = false;
let slideshowIndex = 0;
let slideshowInterval = null;
let slideshowProgressInterval = null;
let currentPhotoElement = 1; // Alterne entre 1 et 2 pour les transitions

let inactivityTimer = null;
let lastActivity = Date.now();

// Initialiser le diaporama au chargement
document.addEventListener('DOMContentLoaded', function() {
    loadSlideshowConfig();
    setupActivityTracking();
});

async function loadSlideshowConfig() {
    try {
        const response = await fetch('/api/slideshow');
        slideshowConfig = await response.json();
        
        if (slideshowConfig.enabled && slideshowConfig.photos.length > 0) {
            slideshowPhotos = slideshowConfig.photos;
            startInactivityTimer();
        }
    } catch (error) {
        console.error('Erreur chargement config diaporama:', error);
    }
}

function setupActivityTracking() {
    // Détecter l'activité utilisateur
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
        document.addEventListener(event, handleActivity, true);
    });
}

function handleActivity(e) {
    lastActivity = Date.now();
    
    // Si le diaporama est actif et qu'on clique ailleurs que sur le bouton
    if (slideshowActive) {
        // Ne pas fermer si on clique sur le bouton capture (il a son propre handler)
        if (e.target.closest('.screensaver-capture-btn')) {
            return;
        }
        stopSlideshow();
        return;
    }
    
    // Redémarrer le timer d'inactivité
    resetInactivityTimer();
}

function resetInactivityTimer() {
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    
    if (slideshowConfig && slideshowConfig.enabled && slideshowPhotos.length > 0) {
        startInactivityTimer();
    }
}

function startInactivityTimer() {
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    
    const delay = (slideshowConfig?.delay || 60) * 1000;
    
    inactivityTimer = setTimeout(() => {
        if (!slideshowActive && !isCapturing && slideshowPhotos.length > 0) {
            startSlideshow();
        }
    }, delay);
}

function startSlideshow() {
    if (slideshowPhotos.length === 0) return;
    
    slideshowActive = true;
    slideshowIndex = 0;
    currentPhotoElement = 1;
    
    const overlay = document.getElementById('slideshowOverlay');
    overlay.classList.remove('d-none');
    
    // Animation d'entrée
    overlay.querySelector('.screensaver-container').classList.add('entering');
    setTimeout(() => {
        overlay.querySelector('.screensaver-container').classList.remove('entering');
    }, 500);
    
    // Afficher la première photo
    showCurrentSlide();
    
    // Démarrer la rotation automatique
    const photoDuration = (slideshowConfig?.photo_duration || 5) * 1000;
    slideshowInterval = setInterval(() => {
        nextSlide();
    }, photoDuration);
    
    // Démarrer la barre de progression
    startProgressBar();
}

function stopSlideshow() {
    slideshowActive = false;
    
    const overlay = document.getElementById('slideshowOverlay');
    overlay.classList.add('d-none');
    
    // Nettoyer les intervals
    if (slideshowInterval) {
        clearInterval(slideshowInterval);
        slideshowInterval = null;
    }
    if (slideshowProgressInterval) {
        clearInterval(slideshowProgressInterval);
        slideshowProgressInterval = null;
    }
    
    // Redémarrer le timer d'inactivité
    startInactivityTimer();
}

function showCurrentSlide() {
    if (slideshowPhotos.length === 0) return;
    
    const photo1 = document.getElementById('slideshowImage1');
    const photo2 = document.getElementById('slideshowImage2');
    const counter = document.getElementById('slideshowCounter');
    
    // Déterminer la source (photos ou effet)
    const source = slideshowConfig?.source === 'effet' ? 'effet' : 'photos';
    const photoUrl = `/${source}/${slideshowPhotos[slideshowIndex]}`;
    
    // Transition fluide entre les deux éléments
    if (currentPhotoElement === 1) {
        photo1.src = photoUrl;
        photo1.classList.add('active');
        photo2.classList.remove('active');
        currentPhotoElement = 2;
    } else {
        photo2.src = photoUrl;
        photo2.classList.add('active');
        photo1.classList.remove('active');
        currentPhotoElement = 1;
    }
    
    counter.textContent = `Photo ${slideshowIndex + 1} sur ${slideshowPhotos.length}`;
    
    // Reset la barre de progression
    startProgressBar();
}

function nextSlide() {
    slideshowIndex = (slideshowIndex + 1) % slideshowPhotos.length;
    showCurrentSlide();
}

function startProgressBar() {
    const progressBar = document.getElementById('slideshowProgress');
    const duration = (slideshowConfig?.photo_duration || 5) * 1000;
    
    // Reset
    progressBar.style.transition = 'none';
    progressBar.style.width = '0%';
    
    // Force reflow
    progressBar.offsetHeight;
    
    // Animer
    progressBar.style.transition = `width ${duration}ms linear`;
    progressBar.style.width = '100%';
}

// Fonction appelée quand on clique sur le bouton "Prendre une photo"
function exitScreensaverAndCapture() {
    stopSlideshow();
    // Petit délai pour que l'overlay se ferme avant de lancer la capture
    setTimeout(() => {
        capturePhoto();
    }, 100);
}



// Vérifier le statut de l'imprimante pour l'alerte papier
function checkPrinterPaperStatus() {
    fetch('/api/printer_status')
        .then(response => response.json())
        .then(data => {
            const paperAlert = document.getElementById('paper-alert');
            
            // Afficher l'alerte seulement si l'imprimante est activée et qu'il y a un problème de papier
            if (data.status === 'ok' && data.paper_status && data.paper_status !== 'ok' && data.paper_status !== 'unknown') {
                paperAlert.classList.remove('d-none');
            } else {
                paperAlert.classList.add('d-none');
            }
        })
        .catch(error => {
            console.error('Erreur vérification papier:', error);
            // Masquer l'alerte en cas d'erreur
            document.getElementById('paper-alert').classList.add('d-none');
        });
}

// Vérifier le papier au chargement et périodiquement
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si on doit forcer l'affichage de l'alerte papier
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('show_paper_alert') === '1') {
        // Forcer l'affichage de l'alerte
        const paperAlert = document.getElementById('paper-alert');
        paperAlert.classList.remove('d-none');
        
        // Nettoyer l'URL sans recharger la page
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    checkPrinterPaperStatus();
    // Vérifier toutes les 30 secondes
    setInterval(checkPrinterPaperStatus, 30000);
});

// Nettoyer les ressources lors de la fermeture
window.addEventListener('beforeunload', function() {
    fetch('/stop_camera').catch(error => {
        console.log('Erreur arrêt caméra:', error);
    });
});
</script>
{% endblock %}
